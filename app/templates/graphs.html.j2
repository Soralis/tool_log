<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', path='favicon.ico') }}">
    <title>Tool Life Monitoring</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-900 text-gray-100">
    <div class="min-h-screen p-4">
        {# <div class="max-w-7xl mx-auto"> #}
        <div>
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold">Tool Life Monitoring</h1>
                <div class="text-gray-400">
                    <span class="font-medium">Server:</span> {{ server_address }}
                </div>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                {% for graph in graphs %}
                <div class="bg-gray-800 rounded-lg shadow p-4">
                    <h3 class="text-lg font-medium mb-2 text-gray-300">{{ graph.title }}</h3>
                    {% with graph_id=graph.id, graph_type=graph.type %}
                        {% include 'partials/graph.html.j2' %}
                    {% endwith %}
                </div>
                {% endfor %}
            </div>

            {% if not graphs %}
            <div class="text-center py-12">
                <p class="text-gray-400 text-lg">No tool life data available. Add tools and record tool life measurements to see graphs.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Connection status indicator -->
    <div id="connection-status" class="fixed bottom-4 right-4 px-4 py-2 rounded-full text-white bg-yellow-500">
        Connecting...
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const graphs = {};
        const statusDiv = document.getElementById('connection-status');
        let ws = null;

        function initializeGraph(containerId, type) {
            const canvas = document.querySelector(`#${containerId} canvas`);
            const ctx = canvas.getContext('2d');
            
            graphs[containerId] = new Chart(ctx, {
                type: type,
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Tool Life',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.5)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Reached Life',
                                color: '#fff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#fff'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time',
                                color: '#fff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#fff'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Life: ${context.parsed.y}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws/graphs`);
            
            ws.onopen = function() {
                statusDiv.className = 'hidden';
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                // Update each graph with its new data
                Object.entries(data).forEach(([graphId, graphData]) => {
                    const graph = graphs[graphId];
                    if (graph) {
                        graph.data.labels = graphData.labels;
                        graph.data.datasets[0].data = graphData.values;
                        graph.update();
                    }
                });
            };

            ws.onclose = function() {
                statusDiv.textContent = 'Reconnecting...';
                statusDiv.className = 'fixed bottom-4 right-4 px-4 py-2 rounded-full text-white bg-yellow-500';
                // Attempt to reconnect after 5 seconds
                setTimeout(connectWebSocket, 5000);
            };

            ws.onerror = function() {
                statusDiv.textContent = 'Connection Error';
                statusDiv.className = 'fixed bottom-4 right-4 px-4 py-2 rounded-full text-white bg-red-500';
            };
        }

        // Initialize all graphs on the page
        document.querySelectorAll('.graph-container').forEach(container => {
            const id = container.id;
            const type = container.dataset.type;
            initializeGraph(id, type);
        });

        // Start WebSocket connection
        connectWebSocket();

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (ws) {
                ws.close();
            }
        });
    </script>

    <style>
        .graph-container {
            height: 200px;
        }
    </style>
</body>
</html>
